// modal.js — рабочие модалки (вход / регистрация / НКО)(function () {    const modalRoot = document.getElementById('modalContainer');    function closeModal() {        if (!modalRoot) return;        modalRoot.innerHTML = '';        document.removeEventListener('keydown', onEsc);    }    function onEsc(e) {        if (e.key === 'Escape') {            closeModal();        }    }    function openShell(innerHtml) {        if (!modalRoot) {            console.warn('[modal] #modalContainer не найден');            return;        }        modalRoot.innerHTML = `          <div class="modal-overlay" id="modalOverlay">            <div class="modal-dialog auth-dialog">              <button class="modal-close" type="button" id="modalCloseBtn">×</button>              ${innerHtml}            </div>          </div>        `;        const overlay = document.getElementById('modalOverlay');        const closeBtn = document.getElementById('modalCloseBtn');        if (overlay) {            overlay.addEventListener('click', (e) => {                if (e.target === overlay) {                    closeModal();                }            });        }        if (closeBtn) {            closeBtn.addEventListener('click', closeModal);        }        document.addEventListener('keydown', onEsc);    }    // ===== ФОРМА ВХОДА =====    function renderLoginForm() {        const html = `          <div class="auth-card">            <h2 class="auth-title">Вход в аккаунт</h2>            <div class="auth-tabs">              <button type="button" class="auth-tab active" data-mode="user">Пользователь</button>              <button type="button" class="auth-tab" data-mode="nko">НКО / инициатива</button>            </div>            <form id="loginForm" class="auth-form" data-mode="user">              <label class="auth-field">                <span class="auth-label">E-mail</span>                <input type="email" name="email" class="auth-input" required>              </label>              <label class="auth-field">                <span class="auth-label">Пароль</span>                <input type="password" name="password" class="auth-input" minlength="10" required>              </label>              <div class="auth-meta-row">                <label class="auth-checkbox">                  <input type="checkbox" name="remember">                  <span>Запомнить меня</span>                </label>                <button type="button" class="auth-link" id="forgotPasswordLink">Забыли пароль?</button>              </div>              <button type="submit" class="auth-primary-btn">Войти</button>              <p class="auth-bottom-text">                Нет аккаунта?                <button type="button" class="auth-link" id="goToRegister">Зарегистрироваться</button>              </p>            </form>          </div>        `;        openShell(html);        const tabs = document.querySelectorAll('.auth-tab');        const form = document.getElementById('loginForm');        tabs.forEach(tab => {            tab.addEventListener('click', () => {                tabs.forEach(t => t.classList.remove('active'));                tab.classList.add('active');                if (form) form.dataset.mode = tab.dataset.mode || 'user';            });        });        if (form) {            form.addEventListener('submit', async (e) => {                e.preventDefault();                const fd = new FormData(form);                const payload = {                    email: fd.get('email'),                    password: fd.get('password'),                    accountType: form.dataset.mode || 'user',                };                try {                    if (window.Api && typeof Api.login === 'function') {                        await Api.login(payload);                    }                    closeModal();                    if (window.Api && Api.getCurrentUser && window.AuthUI && AuthUI.renderUserPanel) {                        const user = await Api.getCurrentUser().catch(() => null);                        AuthUI.renderUserPanel(user);                    }                } catch (err) {                    console.error(err);                    showError('Не удалось войти. Проверьте логин и пароль.');                }            });        }        const goToRegister = document.getElementById('goToRegister');        if (goToRegister) {            goToRegister.addEventListener('click', () => {                renderRegisterForm('volunteer');            });        }        const forgot = document.getElementById('forgotPasswordLink');        if (forgot) {            forgot.addEventListener('click', () => {                showError('Восстановление пароля пока не настроено.');            });        }    }    function showError(msg) {        let box = document.querySelector('.auth-error');        if (!box) {            box = document.createElement('div');            box.className = 'auth-error';            const dialog = document.querySelector('.auth-dialog');            if (dialog) dialog.insertBefore(box, dialog.firstChild);        }        box.textContent = msg;    }    // ===== ФОРМА РЕГИСТРАЦИИ =====    function renderRegisterForm(mode = 'volunteer') {        const isVolunteer = mode === 'volunteer';        const html = `          <div class="auth-card">            <h2 class="auth-title">Регистрация</h2>            <div class="auth-toggle">              <button type="button"                      class="auth-toggle-btn ${isVolunteer ? 'active' : ''}"                      data-mode="volunteer">                Волонтёр              </button>              <button type="button"                      class="auth-toggle-btn ${!isVolunteer ? 'active' : ''}"                      data-mode="initiative">                Инициатива              </button>            </div>            <form id="registerForm" class="auth-form" data-mode="${isVolunteer ? 'volunteer' : 'initiative'}">              <div id="regVolunteer" class="${isVolunteer ? '' : 'hidden'}">                <label class="auth-field">                  <span class="auth-label">Имя и фамилия</span>                  <input type="text" name="full_name" class="auth-input">                </label>                <label class="auth-field">                  <span class="auth-label">E-mail</span>                  <input type="email" name="email" class="auth-input">                </label>              </div>              <div id="regInitiative" class="${isVolunteer ? 'hidden' : ''}">                <label class="auth-field">                  <span class="auth-label">Название НКО / инициативы</span>                  <input type="text" name="org_name" class="auth-input">                </label>                <label class="auth-field">                  <span class="auth-label">Город</span>                  <input type="text" name="city" class="auth-input">                </label>                <label class="auth-field">                  <span class="auth-label">Сфера деятельности</span>                  <input type="text" name="category" class="auth-input">                </label>              </div>              <div class="auth-two-col">                <label class="auth-field">                  <span class="auth-label">Пароль</span>                  <input type="password" name="password" class="auth-input" minlength="10" required>                  <span class="auth-help">Не менее 10 символов</span>                </label>                <label class="auth-field">                  <span class="auth-label">Повтор пароля</span>                  <input type="password" name="password_repeat" class="auth-input" minlength="10" required>                  <span class="auth-help">Не менее 10 символов</span>                </label>              </div>              <button type="submit" class="auth-primary-btn">Зарегистрироваться</button>            </form>          </div>        `;        openShell(html);        const toggleButtons = document.querySelectorAll('.auth-toggle-btn');        const regForm = document.getElementById('registerForm');        const volBlock = document.getElementById('regVolunteer');        const initBlock = document.getElementById('regInitiative');        toggleButtons.forEach(btn => {            btn.addEventListener('click', () => {                const m = btn.dataset.mode;                toggleButtons.forEach(b => b.classList.remove('active'));                btn.classList.add('active');                if (!regForm || !volBlock || !initBlock) return;                regForm.dataset.mode = m;                if (m === 'volunteer') {                    volBlock.classList.remove('hidden');                    initBlock.classList.add('hidden');                } else {                    volBlock.classList.add('hidden');                    initBlock.classList.remove('hidden');                }            });        });        if (regForm) {            regForm.addEventListener('submit', async (e) => {                e.preventDefault();                const fd = new FormData(regForm);                const modeNow = regForm.dataset.mode || 'volunteer';                const payload = {                    accountType: modeNow === 'initiative' ? 'nko' : 'user',                    fullName: fd.get('full_name'),                    email: fd.get('email'),                    orgName: fd.get('org_name'),                    city: fd.get('city'),                    category: fd.get('category'),                    password: fd.get('password'),                    passwordRepeat: fd.get('password_repeat')                };                if (!payload.password || payload.password !== payload.passwordRepeat) {                    showError('Пароли не совпадают');                    return;                }                try {                    if (window.Api && typeof Api.register === 'function') {                        await Api.register(payload);                    }                    closeModal();                    if (window.Api && Api.getCurrentUser && window.AuthUI && AuthUI.renderUserPanel) {                        const user = await Api.getCurrentUser().catch(() => null);                        AuthUI.renderUserPanel(user);                    }                } catch (err) {                    console.error(err);                    showError('Не удалось зарегистрироваться. Попробуйте ещё раз.');                }            });        }    }    // ===== ФОРМА ДОБАВЛЕНИЯ НКО =====    function renderAddNkoForm() {        const html = `          <div class="auth-card">            <h2 class="auth-title">Предложить инициативу / НКО</h2>            <form id="addNkoForm" class="auth-form">              <label class="auth-field">                <span class="auth-label">Название организации</span>                <input type="text" name="name" class="auth-input" required>              </label>              <label class="auth-field">                <span class="auth-label">Город</span>                <input type="text" name="city" class="auth-input" required>              </label>              <label class="auth-field">                <span class="auth-label">Адрес</span>                <input type="text" name="address" class="auth-input">              </label>              <label class="auth-field">                <span class="auth-label">Категория / направление</span>                <input type="text" name="category" class="auth-input">              </label>              <label class="auth-field">                <span class="auth-label">Краткое описание</span>                <textarea name="description" class="auth-input" rows="3"></textarea>              </label>              <label class="auth-field">                <span class="auth-label">Телефон</span>                <input type="text" name="phone" class="auth-input">              </label>              <label class="auth-field">                <span class="auth-label">Ссылка на сайт / соцсети</span>                <input type="text" name="site" class="auth-input">              </label>              <button type="submit" class="auth-primary-btn">Отправить на модерацию</button>            </form>          </div>        `;        openShell(html);        const form = document.getElementById('addNkoForm');        if (form) {            form.addEventListener('submit', async (e) => {                e.preventDefault();                const fd = new FormData(form);                const payload = {                    name: fd.get('name'),                    city: fd.get('city'),                    address: fd.get('address'),                    category: fd.get('category'),                    description: fd.get('description'),                    phone: fd.get('phone'),                    site: fd.get('site')                };                try {                    if (window.Api && typeof Api.createNko === 'function') {                        await Api.createNko(payload);                    }                    closeModal();                    alert('НКО отправлено на модерацию');                } catch (err) {                    console.error(err);                    showError('Не удалось отправить НКО. Попробуйте ещё раз.');                }            });        }    }    // Публичный API    window.Modal = {        openAuthModal(mode = 'login') {            if (mode === 'login') {                renderLoginForm();            } else if (mode === 'register-nko') {                renderRegisterForm('initiative');            } else {                renderRegisterForm('volunteer');            }        },        openAddNkoModal() {            renderAddNkoForm();        },        close: closeModal    };    console.log('[modal] Modal инициализирован');})();