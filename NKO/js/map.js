// map.js — инициализация Яндекс.Карты и отрисовка меток НКОlet mapInstance = null;let markersCollection = null;// публичный объект, которым пользуется app.jswindow.NkoMap = {    initMap,    setMarkers,    focusOnNko};function focusOnNko(nko) {    if (!mapInstance) return;    const lat = Number(nko.lat);    const lng = Number(nko.lng);    if (!lat || !lng || isNaN(lat) || isNaN(lng)) return;    mapInstance.setCenter([lat, lng], 15, { duration: 300 });}function initMap() {    if (!window.ymaps) {        console.error('Yandex Maps API не загружен');        return;    }    ymaps.ready(() => {        const container = document.getElementById('mapContainer');        if (!container) return;        mapInstance = new ymaps.Map('mapContainer', {            center: [55.75, 37.57], // старт — Россия            zoom: 4,            controls: ['zoomControl', 'fullscreenControl']        });        markersCollection = new ymaps.GeoObjectCollection();        mapInstance.geoObjects.add(markersCollection);        // убираем "заглушку загрузки" из map.css        container.classList.add('ready');    });}/** * Устанавливает метки на карту. * @param {Array} nkoList — массив НКО с полями lat, lng, name, category, address, website, phone */function setMarkers(nkoList) {    if (!mapInstance || !markersCollection) {        // карта ещё не готова, подождём и попробуем чуть позже        ymaps.ready(() => setMarkers(nkoList));        return;    }    markersCollection.removeAll();    const boundsPoints = [];    nkoList.forEach(nko => {        const lat = Number(nko.lat);        const lng = Number(nko.lng);        if (!lat || !lng || isNaN(lat) || isNaN(lng)) {            return; // пропускаем НКО без координат        }        const balloonHtml = createBalloonContent(nko);        const placemark = new ymaps.Placemark(            [lat, lng],            {                balloonContent: balloonHtml,                hintContent: nko.name || 'НКО'            },            {                preset: 'islands#redIcon',            }        );        markersCollection.add(placemark);        boundsPoints.push([lat, lng]);    });    if (boundsPoints.length) {        const bounds = ymaps.util.bounds.fromPoints(boundsPoints);        mapInstance.setBounds(bounds, {            checkZoomRange: true,            zoomMargin: 40        });    }}function createBalloonContent(nko) {    const name = escapeHtml(nko.name || 'НКО');    const category = escapeHtml(nko.category || '');    const address = escapeHtml(nko.address || '');    const phone = escapeHtml(nko.phone || '');    const website = nko.website || nko.site || '';    const siteLink = website        ? `<div style="margin-top:6px;">               <a href="${encodeURI(website)}" target="_blank" rel="noopener noreferrer">                   Открыть сайт / соцсети               </a>           </div>`        : '';    const phoneLine = phone ? `<div>Телефон: ${phone}</div>` : '';    const addressLine = address ? `<div>Адрес: ${address}</div>` : '';    const categoryLine = category ? `<div style="color:#5568a4; font-size:12px;">${category}</div>` : '';    return `        <div style="font-size:13px; max-width:260px;">            <div style="font-weight:600; margin-bottom:4px;">${name}</div>            ${categoryLine}            ${addressLine}            ${phoneLine}            ${siteLink}        </div>    `;}function escapeHtml(str) {    return String(str)        .replace(/&/g, '&amp;')        .replace(/</g, '&lt;')        .replace(/>/g, '&gt;')        .replace(/"/g, '&quot;')        .replace(/'/g, '&#039;');}