// app.js ‚Äî –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ù–ö–û, —Ñ–∏–ª—å—Ç—Ä–æ–≤ –∏ –ø–æ–∏—Å–∫–∞let allNko = [];let filteredNko = [];let allEvents = [];let currentCity = ""; // –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥ –¥–ª—è –ù–ö–û –∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π// —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞const searchInput        = document.getElementById('searchInput');const citySelect         = document.getElementById('citySelect');     // –º–æ–∂–µ—Ç –±—ã—Ç—å nullconst categorySelect     = document.getElementById('categorySelect'); // –º–æ–∂–µ—Ç –±—ã—Ç—å nullconst cityNameSpan       = document.getElementById('cityName');const changeCityLink     = document.getElementById('changeCity');const cityDropdownMenu   = document.getElementById('cityDropdownMenu');const cityDropdownToggle = document.getElementById('cityDropdownToggle');const nkoCityTitle       = document.getElementById('nkoCityTitle');document.addEventListener('DOMContentLoaded', () => {    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É    if (window.NkoMap && typeof window.NkoMap.initMap === 'function') {        window.NkoMap.initMap();    }    // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤    initFilters();    // –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ    loadNko();    loadEvents();});// ================== –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ==================async function loadNko() {    try {        const response = await fetch('/api/nko');        if (!response.ok) {            throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ù–ö–û');        }        const data = await response.json();        allNko = Array.isArray(data) ? data : [];        buildCityOptions(allNko);        buildCategoryOptions(allNko);        applyFilters(); // –ø–µ—Ä–≤–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞    } catch (err) {        console.error(err);    }}async function loadEvents() {    try {        const res = await fetch('/api/events');        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π');        const events = await res.json();        allEvents = Array.isArray(events) ? events : [];        renderEventsList();    } catch (e) {        console.error(e);    }}// ================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –§–ò–õ–¨–¢–†–û–í ==================function initFilters() {    if (searchInput) {        searchInput.addEventListener('input', debounce(applyFilters, 250));    }    if (citySelect) {        citySelect.innerHTML = '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>';        citySelect.addEventListener('change', () => {            updateHeaderCity();            applyFilters();        });    }    if (categorySelect) {        categorySelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';        categorySelect.addEventListener('change', applyFilters);    }    if (changeCityLink) {        changeCityLink.addEventListener('click', (e) => {            e.preventDefault();            const mapSection = document.getElementById('map');            if (mapSection) {                mapSection.scrollIntoView({ behavior: 'smooth' });            }        });    }    // –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥—Ä–æ–ø–¥–∞—É–Ω "–≥–æ—Ä–æ–¥–µ"    if (cityDropdownToggle && cityDropdownMenu) {        cityDropdownToggle.addEventListener('click', (e) => {            e.stopPropagation();            cityDropdownMenu.classList.toggle('open');        });        // –∫–ª–∏–∫–∏ –≤–Ω–µ –¥—Ä–æ–ø–¥–∞—É–Ω–∞ –µ–≥–æ –∑–∞–∫—Ä—ã–≤–∞—é—Ç        document.addEventListener('click', () => {            cityDropdownMenu.classList.remove('open');        });    }}// ================== –ì–û–†–û–î–ê / –ö–ê–¢–ï–ì–û–†–ò–ò ==================function normalizeCityName(raw) {    if (!raw) return '';    let c = String(raw).trim();    // —É–±–∏—Ä–∞–µ–º "–≥.", "–≥ " –≤ –Ω–∞—á–∞–ª–µ    c = c.replace(/^–≥\.\s*/i, '').replace(/^–≥\s*/i, '');    // –±–µ—Ä—ë–º —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –¥–æ –ø–µ—Ä–≤–æ–π –∑–∞–ø—è—Ç–æ–π    if (c.includes(',')) {        c = c.split(',')[0];    }    return c.trim();}function buildCityOptions(list) {    const cities = new Set();    list.forEach(nko => {        let city = '';        if (nko.city) {            city = normalizeCityName(nko.city);        } else if (nko.address) {            city = normalizeCityName(extractCityFromAddress(nko.address));        }        if (city) cities.add(city);    });    const sorted = Array.from(cities).sort((a, b) => a.localeCompare(b, 'ru'));    // –∑–∞–ø–æ–ª–Ω—è–µ–º <select>, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å    if (citySelect) {        citySelect.innerHTML = '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>' +            sorted.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');    }    // –∑–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ "–≥–æ—Ä–æ–¥–µ"    if (cityDropdownMenu) {        cityDropdownMenu.innerHTML = sorted.map(            c => `<button type="button" class="city-option">${escapeHtml(c)}</button>`        ).join('');        cityDropdownMenu.querySelectorAll('.city-option').forEach(btn => {            btn.addEventListener('click', (e) => {                e.stopPropagation();                currentCity = btn.textContent.trim();                if (nkoCityTitle) {                    nkoCityTitle.textContent = ' ' + currentCity;                }                if (cityNameSpan) {                    cityNameSpan.textContent = currentCity;                }                cityDropdownMenu.classList.remove('open');                applyFilters();     // –æ–±–Ω–æ–≤–∏—Ç—å –ù–ö–û                renderEventsList(); // –æ–±–Ω–æ–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è            });        });        // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é        if (!currentCity && sorted.length > 0) {            currentCity = sorted[0];        }        if (nkoCityTitle) {            nkoCityTitle.textContent = currentCity ? ' ' + currentCity : '';        }        if (cityNameSpan && currentCity) {            cityNameSpan.textContent = currentCity;        }    }}function buildCategoryOptions(list) {    if (!categorySelect) return;    const categories = new Set();    list.forEach(nko => {        if (nko.category) {            categories.add(nko.category.trim());        }    });    const sorted = Array.from(categories).sort((a, b) => a.localeCompare(b, 'ru'));    categorySelect.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +        sorted.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');}// ================== –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –ù–ö–û ==================function applyFilters() {    const filterCity = normalizeCityName(currentCity || (citySelect?.value || ''));    const q = (searchInput?.value || '').trim().toLowerCase();    const category = categorySelect?.value || '';    filteredNko = allNko.filter(nko => {        let ok = true;        if (q) {            const name = (nko.name || '').toLowerCase();            const desc = (nko.description || '').toLowerCase();            const cat  = (nko.category || '').toLowerCase();            ok = name.includes(q) || desc.includes(q) || cat.includes(q);        }        if (ok && filterCity) {            const nkoCity = normalizeCityName(nko.city || extractCityFromAddress(nko.address));            if (nkoCity !== filterCity) ok = false;        }        if (ok && category) {            if ((nko.category || '').trim() !== category) ok = false;        }        return ok;    });    // –ø–µ—Ä–µ–¥–∞—ë–º –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–∞ –∫–∞—Ä—Ç—É    if (window.NkoMap && typeof window.NkoMap.setMarkers === 'function') {        window.NkoMap.setMarkers(filteredNko);    }    // –∏ –≤ —Å–ø–∏—Å–æ–∫ —Å–ª–µ–≤–∞    renderNkoList(filteredNko);}// —Å–ø–∏—Å–æ–∫ –ù–ö–û —Å–ª–µ–≤–∞ –æ—Ç –∫–∞—Ä—Ç—ãfunction renderNkoList(list) {    const container = document.getElementById('nkoList');    if (!container) return;    container.innerHTML = '';    if (!list.length) {        container.innerHTML = '<div style="font-size:13px;color:#6b7395;">–ù–ö–û –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ò–∑–º–µ–Ω–∏—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –≥–æ—Ä–æ–¥.</div>';        return;    }    if (nkoCityTitle) {        nkoCityTitle.textContent = currentCity ? ' ' + currentCity : '';    }    list.forEach(nko => {        const card = document.createElement('div');        card.className = 'nko-card';        card.dataset.id = nko.id;        const logo = nko.logo || 'img/placeholder.png';        card.innerHTML = `            <div class="nko-card-logo">                <img src="${logo}" alt="">            </div>            <div>                <div class="nko-card-title">${escapeHtml(nko.name || '–ù–ö–û')}</div>                <div class="nko-card-address">${escapeHtml(nko.address || '')}</div>                ${                    nko.category                        ? `<div class="nko-card-tag">${escapeHtml(nko.category)}</div>`                        : ''                }            </div>            <div class="nko-card-fav">‚ô°</div>        `;        // –∫–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–µ ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –∏ –æ—Ç–∫—Ä–æ–µ–º –ø–æ–¥—Ä–æ–±–Ω—É—é –∫–∞—Ä—Ç–æ—á–∫—É        card.addEventListener('click', () => {            if (window.NkoMap && typeof window.NkoMap.focusOnNko === 'function') {                window.NkoMap.focusOnNko(nko);            }            if (window.Modal && typeof window.Modal.openNkoDetail === 'function') {                window.Modal.openNkoDetail(nko);            }        });        container.appendChild(card);    });}// ================== –ú–ï–†–û–ü–†–ò–Ø–¢–ò–Ø ==================function renderEventsList() {    const container = document.getElementById('eventsList');    const cityTitle = document.getElementById('eventsCityTitle');    if (!container) return;    const filterCity = (currentCity || '').trim();    let list = allEvents;    // –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥—É: –∏—â–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –≤–Ω—É—Ç—Ä–∏ —Å—Ç—Ä–æ–∫–∏ –∏–∑ –ë–î    if (filterCity) {        const needle = filterCity.toLowerCase();        list = allEvents.filter(ev => {            const rawCity = String(ev.city || '').toLowerCase();            const rawAddr = String(ev.address || '').toLowerCase();            return rawCity.includes(needle) || rawAddr.includes(needle);        });    }    container.innerHTML = '';    if (!list.length) {        container.innerHTML = '<div style="font-size:14px;opacity:.85;">–í —ç—Ç–æ–º –≥–æ—Ä–æ–¥–µ –ø–æ–∫–∞ –Ω–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.</div>';        if (cityTitle && filterCity) {            cityTitle.textContent = '–≥. ' + filterCity;        }        return;    }    // –ë–µ—Ä—ë–º –≥–æ—Ä–æ–¥ –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–∞    const cityForTitle = filterCity ||        (String(list[0].city || list[0].address || '').split(',')[0].trim());    if (cityTitle) {        cityTitle.textContent = cityForTitle ? '–≥. ' + cityForTitle : '';    }    list.forEach(ev => {        const card = document.createElement('div');        card.className = 'event-card';        // –ö–∞—Ä—Ç–∏–Ω–∫–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ü–û–õ–ù–û–°–¢–¨–Æ –∏–∑ –ë–î        const imgSrc = ev.image || 'img/events/default.jpg';        card.innerHTML = `            <img src="${imgSrc}" alt="">            <div class="event-card-title">${escapeHtml(ev.title || '')}</div>            <div class="event-card-meta">                üìç ${escapeHtml(ev.address || '')}<br>                üìÖ ${escapeHtml(ev.date || '')} &nbsp;&nbsp; ‚è∞ ${escapeHtml(ev.time || '')}            </div>            ${                ev.category                    ? `<div class="event-card-category">${escapeHtml(ev.category)}</div>`                    : ''            }        `;        container.appendChild(card);    });}// ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï ==================function updateHeaderCity() {    if (!cityNameSpan || !citySelect) return;    const value = citySelect.value;    cityNameSpan.textContent = value || '–í—Å–µ –≥–æ—Ä–æ–¥–∞';}function extractCityFromAddress(address) {    if (!address) return '';    return address.split(',')[0] || '';}function debounce(fn, delay) {    let timer;    return (...args) => {        clearTimeout(timer);        timer = setTimeout(() => fn.apply(null, args), delay);    };}function escapeHtml(str) {    return String(str)        .replace(/&/g, '&amp;')        .replace(/</g, '&lt;')        .replace(/>/g, '&gt;')        .replace(/"/g, '&quot;')        .replace(/'/g, '&#039;');}